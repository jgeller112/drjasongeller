<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Jason Geller">
<meta name="dcterms.date" content="2021-04-21">
<meta name="description" content="I demonstrate how to analyze pupil data from a GazePoint tracker with my eye-tracking R package gazeR.">
<title>Analzying GazePoint Pupil Data With GazeR | Jason Geller – Jason Geller, Ph.D.</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style type="text/css">
hr.dinkus {
    width: 50px;
    margin: 2em auto 2em;
    border-top: 5px dotted #454545;
}

div.column-margin+hr.dinkus {
    margin: 1em auto 2em;
}
</style>
<meta name="twitter:title" content="Analzying GazePoint Pupil Data With GazeR | Jason Geller">
<meta name="twitter:description" content="I demonstrate how to analyze pupil data from a GazePoint tracker with my eye-tracking R package gazeR.">
<meta name="twitter:image" content="https://www.drjasongeller.com/files/profiles/twitter-card-large.png">
<meta name="twitter:creator" content="@jgeller_phd">
<meta name="twitter:site" content="@jgeller_phd">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Jason Geller, Ph.D.</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../Research/index.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../Talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../Teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../Software/index.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com/citations?user=yO68sggAAAAJ&amp;hl=en"> 
<span class="menu-text"><i class="ai  ai-google-scholar"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jgeller112"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Analzying GazePoint Pupil Data With GazeR</h1>
  <div class="quarto-categories">
    <div class="quarto-category">r</div>
    <div class="quarto-category">pupillometry</div>
    <div class="quarto-category">statistics</div>
  </div>
  </div>

<div>
  <div class="description">
    I demonstrate how to analyze pupil data from a GazePoint tracker with my eye-tracking R package gazeR.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 21, 2021</p>
    </div>
  </div>
  
    
  </div>
  


</header><p>In this vignette I am going to show you how to read in a GazePoint data file along with some behavioral data and use <code>gazeR</code> to preprocess the data.</p>
<p>Special thanks to Matthew K Robinson (Twitter:<span class="citation" data-cites="matthewkrobinson">@matthewkrobinson</span>) for letting me use some data from an auditory oddball task he conducted on himself (we do what we have to do as researchers :D): see Tweet below.</p>
<p></p>
<div id="tweet-77479"></div>
<script>tweet={"url":"https:\/\/twitter.com\/matthewkrobison\/status\/1384208857790959617","author_name":"Matthew K. Robison","author_url":"https:\/\/twitter.com\/matthewkrobison","html":"\u003Cblockquote class=\"twitter-tweet\" align=\"center\"\u003E\u003Cp lang=\"en\" dir=\"ltr\"\u003Ei&#39;m just a guy, running himself through auditory oddball tasks on his new eye-tracker, asking it to love him back. \u003Ca href=\"https:\/\/t.co\/wPb97MZuNF\"\u003Epic.twitter.com\/wPb97MZuNF\u003C\/a\u003E\u003C\/p\u003E&mdash; Matthew K. Robison (@matthewkrobison) \u003Ca href=\"https:\/\/twitter.com\/matthewkrobison\/status\/1384208857790959617?ref_src=twsrc%5Etfw\"\u003EApril 19, 2021\u003C\/a\u003E\u003C\/blockquote\u003E\n\u003Cscript async src=\"https:\/\/platform.twitter.com\/widgets.js\" charset=\"utf-8\"\u003E\u003C\/script\u003E\n\n","width":550,"height":null,"type":"rich","cache_age":"3153600000","provider_name":"Twitter","provider_url":"https:\/\/twitter.com","version":"1.0"};document.getElementById("tweet-77479").innerHTML = tweet["html"];</script><p>To get started, we need to load in some important packages and read in the GP data files.</p>
<section id="load-packages" class="level2"><h2 class="anchored" data-anchor-id="load-packages">Load Packages</h2>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org">remotes</a></span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"dmirman/gazer"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/dmirman/gazer">gazer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"tmalsburg/saccades/saccades"</span>, dependencies<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tmalsburg/saccades">saccades</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="read-data" class="level2"><h2 class="anchored" data-anchor-id="read-data">Read Data</h2>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="st">'oddball_eye_13.tsv'</span><span class="op">)</span> <span class="co"># eye data </span></span>
<span><span class="va">bs</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="st">'oddball_13.tsv'</span><span class="op">)</span> <span class="co"># behave data</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pd</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     CNT     TIME    TIME_TICK    FPOGX     FPOGY    FPOGS   FPOGD FPOGID FPOGV
   &lt;int&gt;    &lt;num&gt;        &lt;i64&gt;    &lt;num&gt;     &lt;num&gt;    &lt;num&gt;   &lt;num&gt;  &lt;int&gt; &lt;int&gt;
1: 77433 1251.964 102150661899 -4.40518 -13.98604 1251.883 0.08093   1917     1
2: 77434 1251.980 102150821625 -4.39508 -13.95200 1251.883 0.09692   1917     1
3: 77435 1251.996 102150983307 -4.36427 -13.84678 1251.883 0.09692   1917     0
4: 77436 1252.013 102151149297 -4.40694 -13.99395 1251.883 0.09692   1917     0
5: 77437 1252.028 102151307171 -4.42096 -14.04383 1251.883 0.09692   1917     0
6: 77438 1252.045 102151469190 -4.40730 -14.00445 1251.883 0.09692   1917     0
     LPOGX   LPOGY LPOGV    RPOGX     RPOGY RPOGV    BPOGX     BPOGY BPOGV
     &lt;num&gt;   &lt;num&gt; &lt;int&gt;    &lt;num&gt;     &lt;num&gt; &lt;int&gt;    &lt;num&gt;     &lt;num&gt; &lt;int&gt;
1: 0.71795 0.50537     1 -9.38697 -28.00086     1 -4.33451 -13.74775     1
2: 0.71795 0.50537     1 -9.38697 -28.00086     1 -4.33451 -13.74775     1
3: 0.70711 0.51136     1 -9.14516 -27.18135     1 -4.21902 -13.33500     1
4: 0.70151 0.43055     1 -9.60071 -28.71280     1 -4.44960 -14.14113     1
5: 0.70270 0.42562     1 -9.60071 -28.71280     1 -4.44900 -14.14359     1
6: 0.69827 0.43625     1 -9.34484 -27.89350     1 -4.32329 -13.72862     1
      LPCX    LPCY      LPD     LPS   LPV    RPCX    RPCY      RPD   RPS   RPV
     &lt;num&gt;   &lt;num&gt;    &lt;num&gt;   &lt;num&gt; &lt;int&gt;   &lt;num&gt;   &lt;num&gt;    &lt;num&gt; &lt;num&gt; &lt;int&gt;
1: 0.34860 0.59214 25.23420 0.83829     1 0.64310 0.60511 28.49240     1     1
2: 0.34860 0.59216 25.27127 0.83829     1 0.64314 0.60509 28.33148     1     1
3: 0.34845 0.59234 25.09805 0.83829     1 0.64293 0.60517 28.69580     1     1
4: 0.34846 0.59237 25.15947 0.83829     1 0.64286 0.60519 28.47081     1     1
5: 0.34838 0.59240 25.32249 0.84484     1 0.64285 0.60518 28.46784     1     1
6: 0.34830 0.59240 25.07680 0.85139     1 0.64269 0.60527 28.50588     1     1
      LEYEX    LEYEY   LEYEZ LPUPILD LPUPILV   REYEX    REYEY   REYEZ RPUPILD
      &lt;num&gt;    &lt;num&gt;   &lt;num&gt;   &lt;num&gt;   &lt;int&gt;   &lt;num&gt;    &lt;num&gt;   &lt;num&gt;   &lt;num&gt;
1: -0.03362 -0.01726 0.56538 0.00455       1 0.03052 -0.01989 0.57411 0.00512
2: -0.03438 -0.01769 0.57821 0.00451       1 0.03056 -0.01997 0.57644 0.00513
3: -0.03438 -0.01769 0.57821 0.00449       1 0.03056 -0.01997 0.57644 0.00510
4: -0.03438 -0.01769 0.57821 0.00451       1 0.03056 -0.01997 0.57644 0.00509
5: -0.03501 -0.01795 0.58649 0.00448       1 0.03130 -0.02049 0.59132 0.00509
6: -0.03501 -0.01795 0.58649 0.00450       1 0.03130 -0.02049 0.59132 0.00508
   RPUPILV      CX      CY    CS  BKID BKDUR BKPMIN    LPMM LPMMV    RPMM RPMMV
     &lt;int&gt;   &lt;num&gt;   &lt;num&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt;  &lt;int&gt;   &lt;num&gt; &lt;int&gt;   &lt;num&gt; &lt;int&gt;
1:       1 0.33333 0.33333     0     0     0     20 4.54567     1 5.11614     1
2:       1 0.33333 0.33333     0     0     0     20 4.51065     1 5.12683     1
3:       1 0.33333 0.33333     0     0     0     20 4.48607     1 5.10490     1
4:       1 0.33333 0.33333     0     0     0     20 4.50748     1 5.09460     1
5:       1 0.33333 0.33333     0     0     0     20 4.47957     1 5.08827     1
6:       1 0.33333 0.33333     0     0     0     20 4.50258     1 5.07552     1
    DIAL DIALV   GSR  GSRV    HR   HRV   HRP  TTL0  TTL1  TTLV            USER
   &lt;num&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;          &lt;char&gt;
1: 0.088     1     0     0     0     0   454    -1    -1     0               0
2: 0.088     1     0     0     0     0   484    -1    -1     0 STARTEXPERIMENT
3: 0.088     1     0     0     0     0   456    -1    -1     0 STARTEXPERIMENT
4: 0.088     1     0     0     0     0   451    -1    -1     0           START
5: 0.088     1     0     0     0     0   482    -1    -1     0           START
6: 0.088     1     0     0     0     0   454    -1    -1     0           START</code></pre>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">bs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   subject trial   tone    rt response
     &lt;int&gt; &lt;int&gt; &lt;char&gt; &lt;int&gt;   &lt;char&gt;
1:      13     1     lo  2113     None
2:      13     2     lo  2102     None
3:      13     3     lo  2107     None
4:      13     4     lo  2108     None
5:      13     5     lo  2107     None
6:      13     6     lo  2103     None</code></pre>
</div>
</div>
<p>What we are going to do is run the GazePoint file through the <code>merge_gazepoint</code> function. The function below takes a list of files called file_list and merges all the files together, appends a subject column, creates a trial column using the USER column (GazePoint only allows messages through this channel), creates a time variable (in milliseconds). In the <code>merge_gazepoint</code> function the <code>trail_msg</code> argument requires users to denote a message used in the USER column that references the start of the trial–in our case the <code>START</code> message denotes the start of a new trial. This is a solution by Matt Robinson, but there are other ways one could extract the trial number. What I have done in the past is append a message with the trial iteration (e.g., START_1) in Python and use the <code>separate</code> function to get the trial number.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># A "monocular mean" averages both eyes together. If data is available in just</span></span>
<span><span class="co"># one eye, use the available value as the mean, unless we need_both is TRUE.</span></span>
<span><span class="co">#' @param x1 pupil left</span></span>
<span><span class="co">#' @param x2 pupil right</span></span>
<span><span class="co">#' @return vector with monocular mean values</span></span>
<span><span class="va">compute_monocular_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">xm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="co"># NaN =&gt; NA</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">xm</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">xm</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># function for processing GazePoint data</span></span>
<span><span class="va">merge_gazepoint</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">file_list</span>, <span class="va">trial_msg</span> <span class="op">=</span> <span class="st">"START"</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#file list is path to .xls files</span></span>
<span>  <span class="co">#vroom is faster</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">file_ids</span><span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">file_list</span><span class="op">)</span>,<span class="st">"([:alpha:]|[:punct:])"</span>,<span class="st">""</span><span class="op">)</span> <span class="co"># remove everything but numeric values</span></span>
<span>                   </span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span><span class="va">file_list</span>, <span class="va">file_ids</span>, <span class="op">~</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  </span>
<span>  <span class="va">d</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pupil<span class="op">=</span><span class="fu">compute_monocular_mean</span><span class="op">(</span><span class="va">RPMM</span>, <span class="va">LPMM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># average both eyes</span></span>
<span>             <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pupil <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">RPMMV</span> <span class="op">==</span> <span class="fl">0</span><span class="op">|</span><span class="va">LPMMV</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">pupil</span><span class="op">)</span>,  <span class="co">#missing data labeled as blinks</span></span>
<span>         new_trial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">USER</span> <span class="op">==</span> <span class="va">trial_msg</span> <span class="op">&amp;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">USER</span><span class="op">)</span> <span class="op">!=</span> <span class="va">trial_msg</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, <span class="co"># Label new trials</span></span>
<span>         trial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">new_trial</span><span class="op">)</span>, <span class="co"># Create a trial variable</span></span>
<span>         time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">TIME</span><span class="op">*</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">time</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">time</span>,<span class="va">trial</span>,<span class="va">pupil</span>,<span class="va">BPOGX</span>, <span class="va">BPOGY</span>, <span class="va">USER</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"message"</span> <span class="op">=</span> <span class="st">"USER"</span>, <span class="st">"subject"</span><span class="op">=</span> <span class="st">"id"</span>, <span class="st">"x"</span> <span class="op">=</span> <span class="st">"BPOGX"</span>, <span class="st">"y"</span> <span class="op">=</span> <span class="st">"BPOGY"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trial</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="merge-files" class="level2"><h2 class="anchored" data-anchor-id="merge-files">Merge Files</h2>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># setwd</span></span>
<span></span>
<span><span class="va">gp_file</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"eye_13.tsv"</span><span class="op">)</span> <span class="co"># get files </span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span><span class="va">d</span><span class="op">=</span><span class="fu">merge_gazepoint</span><span class="op">(</span><span class="va">gp_file</span>, trial_msg <span class="op">=</span> <span class="st">"START"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">subject</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">subject</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">bs</span>, <span class="va">d</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">pdb</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pdb</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 73,724 × 10
   subject trial tone     rt response  time pupil     x     y message
     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
 1      13     1 lo     2113 None         0  4.80 -4.45 -14.1 START  
 2      13     1 lo     2113 None        16  4.78 -4.45 -14.1 START  
 3      13     1 lo     2113 None        32  4.79 -4.32 -13.7 START  
 4      13     1 lo     2113 None        48  4.80 -4.58 -14.5 START  
 5      13     1 lo     2113 None        64  4.80 -4.58 -14.5 START  
 6      13     1 lo     2113 None        81  4.79 -4.63 -14.7 START  
 7      13     1 lo     2113 None        97  4.81 -4.42 -14.0 START  
 8      13     1 lo     2113 None       113  4.80 -4.42 -14.0 TONE   
 9      13     1 lo     2113 None       129  4.78 -4.23 -13.5 TONE   
10      13     1 lo     2113 None       145  4.77 -4.34 -13.8 TONE   
# ℹ 73,714 more rows</code></pre>
</div>
</div>
</section><section id="blinks" class="level2"><h2 class="anchored" data-anchor-id="blinks">Blinks</h2>
<section id="finding-blinks" class="level3"><h3 class="anchored" data-anchor-id="finding-blinks">Finding Blinks</h3>
<p>The GazePoint data does not indicate where blinks occurred. What we are going to do is use the <code>blink_detect</code> function in gazer. This relies on the <code>saccades</code> package (<a href="https://github.com/tmalsburg/saccades)" class="uri">https://github.com/tmalsburg/saccades)</a> which uses a velocity based measure based on X,Y coordinates to find blinks. Once we find the blinks we can change the pupil size at that time point as NA and interpolate over it.</p>
<p>As a note, the GazePoint does not seem to sample consistently. In this case, it samples every 16 or 17 ms. This is a problem for some other blink detection measures (e.g., the noise based pupil function). One soultion would be to downsample the data at the onset so there is consistancy from sample to sample.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">blinks_merge</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gazer/man/blink_detect.html">blink_detect</a></span><span class="op">(</span><span class="va">pdb</span><span class="op">)</span></span>
<span></span>
<span> <span class="va">blinks</span> <span class="op">&lt;-</span> <span class="va">blinks_merge</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>grp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">startend</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="va">startend</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/last.html">first</a></span><span class="op">(</span><span class="va">startend</span><span class="op">)</span> <span class="op">==</span> <span class="st">'start'</span>, <span class="st">'start'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">#extends the start message forward until end message</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="co"># label blinks as 1</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">trial</span>, <span class="va">time</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">pupil</span>, <span class="va">message</span>, <span class="va">tone</span>,  <span class="va">Label</span>, <span class="op">-</span><span class="va">grp</span><span class="op">)</span></span>
<span> </span>
<span> </span>
<span> <span class="va">blinks_data</span> <span class="op">&lt;-</span> <span class="va">blinks</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>blink<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Label</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, pupil<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">blink</span><span class="op">==</span><span class="fl">1</span> <span class="op">|</span> <span class="va">pupil</span><span class="op">==</span><span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">pupil</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">time</span>, <span class="va">trial</span>, <span class="va">pupil</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">trial</span>, <span class="va">message</span>, <span class="va">tone</span>, <span class="va">blink</span>, <span class="op">-</span><span class="va">Label</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is a look at the trials containing blinks:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">blinks_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">blink</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: right;">subject</th>
<th style="text-align: right;">time</th>
<th style="text-align: right;">trial</th>
<th style="text-align: right;">pupil</th>
<th style="text-align: right;">x</th>
<th style="text-align: right;">y</th>
<th style="text-align: left;">message</th>
<th style="text-align: left;">tone</th>
<th style="text-align: right;">blink</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">2167</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.9364</td>
<td style="text-align: right;">1.95015</td>
<td style="text-align: left;">POSTTONE</td>
<td style="text-align: left;">lo</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">13</td>
<td style="text-align: right;">2183</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.9364</td>
<td style="text-align: right;">1.95015</td>
<td style="text-align: left;">POSTTONE</td>
<td style="text-align: left;">lo</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">2199</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.9364</td>
<td style="text-align: right;">1.95015</td>
<td style="text-align: left;">POSTTONE</td>
<td style="text-align: left;">lo</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">13</td>
<td style="text-align: right;">2216</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.9364</td>
<td style="text-align: right;">1.95015</td>
<td style="text-align: left;">POSTTONE</td>
<td style="text-align: left;">lo</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.9364</td>
<td style="text-align: right;">1.95015</td>
<td style="text-align: left;">START</td>
<td style="text-align: left;">hi</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">13</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.9364</td>
<td style="text-align: right;">1.95015</td>
<td style="text-align: left;">START</td>
<td style="text-align: left;">hi</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="extending-blinks" class="level3"><h3 class="anchored" data-anchor-id="extending-blinks">Extending Blinks</h3>
<p>I am extending blinks 100 ms forward and backward in time.</p>
</section><section id="interpolate-blinks" class="level3"><h3 class="anchored" data-anchor-id="interpolate-blinks">Interpolate Blinks</h3>
<p>Here let’s linearly interpolate the blinks and then smooth the data using a 5-point moving average.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Smooth and Interpolate</span></span>
<span><span class="va">smooth_interp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gazer/man/smooth_interpolate_pupil.html">smooth_interpolate_pupil</a></span><span class="op">(</span><span class="va">pup_extend</span>, pupil<span class="op">=</span><span class="st">"pupil"</span>, extendpupil<span class="op">=</span><span class="st">"extendpupil"</span>, extendblinks<span class="op">=</span><span class="cn">TRUE</span>, step.first<span class="op">=</span><span class="st">"smooth"</span>, maxgap<span class="op">=</span><span class="cn">Inf</span>, type<span class="op">=</span><span class="st">"linear"</span>, hz<span class="op">=</span><span class="fl">60</span>, n<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="plot-interpolated-trial" class="level2"><h2 class="anchored" data-anchor-id="plot-interpolated-trial">Plot Interpolated Trial</h2>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">interp_graph</span> <span class="op">&lt;-</span> <span class="va">smooth_interp</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trial</span><span class="op">==</span><span class="st">"400"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="co">#axis bold</span></span>
<span><span class="co">#Graph interpolation</span></span>
<span><span class="va">pup_g</span><span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">interp_graph</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">time</span>, y<span class="op">=</span> <span class="va">pupil</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">pup_interp</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"darkgreen"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time (ms)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Pupil Size (mm)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>, axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">16</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>, axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>, axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">pup_g</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="baseline-correction" class="level2"><h2 class="anchored" data-anchor-id="baseline-correction">Baseline Correction</h2>
<p>Here we will do a subtractive baseline correction taking 250 ms before the onset of the tone as baseline.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#use messages to baseline correct</span></span>
<span><span class="va">baseline_pupil</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/gazer/man/baseline_correction_pupil.html">baseline_correction_pupil</a></span><span class="op">(</span><span class="va">smooth_interp</span>, pupil_colname<span class="op">=</span><span class="st">"pup_interp"</span>, baseline_window<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span><span class="op">)</span>, baseline_method <span class="op">=</span> <span class="st">"sub"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">baseline_pupil</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 13
  subject trial baseline  time pupil     x     y message tone  blink extendpupil
    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt; &lt;dbl&gt;       &lt;dbl&gt;
1      13     1     4.80     0  4.80 -4.45 -14.1 START   lo        0        4.80
2      13     1     4.80    16  4.78 -4.45 -14.1 START   lo        0        4.78
3      13     1     4.80    32  4.79 -4.32 -13.7 START   lo        0        4.79
4      13     1     4.80    48  4.80 -4.58 -14.5 START   lo        0        4.80
5      13     1     4.80    64  4.80 -4.58 -14.5 START   lo        0        4.80
6      13     1     4.80    81  4.79 -4.63 -14.7 START   lo        0        4.79
# ℹ 2 more variables: pup_interp &lt;dbl&gt;, baselinecorrectedp &lt;dbl&gt;</code></pre>
</div>
</div>
</section><section id="missing-data" class="level2"><h2 class="anchored" data-anchor-id="missing-data">Missing Data</h2>
<p>Let’s see how much missing data there is and remove trials with greater than 20% missing data.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pup_missing</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/gazer/man/count_missing_pupil.html">count_missing_pupil</a></span><span class="op">(</span><span class="va">baseline_pupil</span>, missingthresh <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span></span>
<span><span class="co"># remove outliers</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I remove about 15 percent of trials.</p>
</section><section id="unlikely-pupil-sizes" class="level2"><h2 class="anchored" data-anchor-id="unlikely-pupil-sizes">Unlikely Pupil Sizes</h2>
<p>Now let’s keep pupil diameter sizes between 2 mm and 9 mm</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pup_outliers</span><span class="op">&lt;-</span><span class="va">pup_missing</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span> <span class="op">(</span><span class="va">pup_interp</span>  <span class="op">&gt;=</span> <span class="fl">2</span>, <span class="va">pup_interp</span> <span class="op">&lt;=</span> <span class="fl">9</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="mad" class="level2"><h2 class="anchored" data-anchor-id="mad">MAD</h2>
<p>Get rid of artifacts we might have missed during some earlier steps.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="co">#MAD removal</span></span>
<span><span class="va">max_removal</span><span class="op">&lt;-</span><span class="va">pup_missing</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>speed<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/gazer/man/speed_pupil.html">speed_pupil</a></span><span class="op">(</span><span class="va">pup_interp</span>,<span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>MAD<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/gazer/man/calc_mad.html">calc_mad</a></span><span class="op">(</span><span class="va">speed</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">speed</span> <span class="op">&lt;</span> <span class="va">MAD</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="onset" class="level2"><h2 class="anchored" data-anchor-id="onset">Onset</h2>
<p>Let’s only look fron the start of the trial until 1500 ms</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">baseline_pupil_onset</span><span class="op">&lt;-</span><span class="va">max_removal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="fl">1500</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">trial</span>, <span class="va">time</span>,<span class="va">baselinecorrectedp</span>, <span class="va">tone</span>, <span class="va">time</span>,<span class="va">message</span>,<span class="va">baselinecorrectedp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="downsample" class="level2"><h2 class="anchored" data-anchor-id="downsample">Downsample</h2>
<p>Downsample the time-course to 50 ms.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#downsample</span></span>
<span><span class="va">timebins1</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gazer/man/downsample_gaze.html">downsample_gaze</a></span><span class="op">(</span><span class="va">baseline_pupil_onset</span>, bin.length<span class="op">=</span><span class="fl">50</span>, timevar <span class="op">=</span> <span class="st">"time"</span>, aggvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"subject"</span>, <span class="st">"tone"</span>, <span class="st">"timebins"</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"pupil"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">timebins1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 62 × 4
   subject tone  timebins aggbaseline
     &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;       &lt;dbl&gt;
 1      13 hi           0    0.00130 
 2      13 hi          50   -0.000752
 3      13 hi         100   -0.00206 
 4      13 hi         150    0.000331
 5      13 hi         200    0.00530 
 6      13 hi         250    0.00503 
 7      13 hi         300    0.00826 
 8      13 hi         350    0.00930 
 9      13 hi         400    0.0116  
10      13 hi         450    0.0125  
# ℹ 52 more rows</code></pre>
</div>
</div>
</section><section id="visualize-time-course" class="level2"><h2 class="anchored" data-anchor-id="visualize-time-course">Visualize Time-course</h2>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cursive_plot</span> <span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">timebins1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">timebins</span>, <span class="va">aggbaseline</span>, linetype<span class="op">=</span><span class="va">tone</span>, color<span class="op">=</span><span class="va">tone</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">"mean"</span>, geom <span class="op">=</span> <span class="st">"line"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span><span class="st">"Time (ms)"</span>,y <span class="op">=</span><span class="st">"Pupil Dilation (baseline - pupil))"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0.0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cursive_plot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks very similar to the one in the Tweet albeit a bit smoother as a result of the extra preprocessing done.</p>


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{2021,
  author = {},
  title = {Analzying {GazePoint} {Pupil} {Data} {With} {GazeR}},
  date = {2021-04-21},
  url = {https://www.drjasongeller.com/blog/posts/2021-04-21-gazePoint_gazer_2/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-2021" class="csl-entry quarto-appendix-citeas" role="listitem">
<em>Analzying GazePoint Pupil Data With GazeR</em>. (2021, April 21). <a href="https://www.drjasongeller.com/blog/posts/2021-04-21-gazePoint_gazer_2/">https://www.drjasongeller.com/blog/posts/2021-04-21-gazePoint_gazer_2/</a>
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.drjasongeller\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2024 Jason Geller</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-7459-4505">0000-0002-7459-4505</a></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/jgeller112/drjasongeller">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


<script src="https://platform.twitter.com/widgets.js"></script>
</body></html>